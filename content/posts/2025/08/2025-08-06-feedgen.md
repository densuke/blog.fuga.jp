---
layout: post
title:  "フィードジェネレーターの開発(n番煎じ)"
date:   2025-08-06 07:41:54+0900
categories: [サーバー, rss]
---
n8nでRSSフィードから記事内容をざっくり取得して、自分の欲しい情報と思われるものをDiscordの個人チャネルへ流すというツールを作っていくと、一部のサイトではRSSが存在しなかったりすることが問題されたりします。

そこで、いたるところであるとは思いつつも、適当にフィードを生成するツールが欲しいということになって、ClaudeさんとGeminiさんに協業してもらいながら作成しています。
<!--more-->

# ポイントとして

- セルフホスティングであること(自分のサーバーで走ること)
  - これがコスト最小限への道だと思う、GCPのAlways Freeでも普通に動きます
- CLIで動かせること
  - 動作チェックやフィードURLのみ生成するときに便利

まずはこの辺りから始めることにして、Claude/Geminiに対するバイブコーディング的な開発を行っています。
個人的な作り方として、以下を意識しています。

- やりたいことをtask.mdというファイルを作って書き出す。

```markdown task.md
# なにを作るか

引数もしくは設定ファイルにより、URLを渡すことで、そこに書かれた内容を分析してRSS feedを生成・出力するプログラム。

# どのように作るか

- Pythonベースで実装する。
- Python環境はuvで初期環境を構築済みのため、uvで必要なライブラリは登録していく
- 基本的な開発方法はグラウンドルールに従う
    - タスクに応じたブランチを作って切り替える、可能であればワークツリー機能で切り分けることで並列化も検討する
    - 仕様を決める
      - EARS表記法をベースにspec.mdに記載する
    - 使用に応じたテストを作り、Red状態であることを確認する
    - 実装する、テストが通る(Green)かを検証する、ダメなら再度実装を点検していく
    - Greenとなったところでリファクタリングを実行し、コードの品質を上げていく
    - 仕様と間違ったことになっていないかを再度点検する
    - コミットしてmainにマージする、完了ブランチは適宜削除していく
- 関数・メソッドはそれぞれがシンプルな作りとなることを意識する
- 型ヒントおよびdocstringを記載する、可能であればdoctestも入れて使い方をはっきりさせておく
- テストはpytestを使用する
- コードの品質はRuffでチェックする
- 不要なファイルはできる限り.gitignoreに登録し、早いうちに混入しないように配慮する、場合によってはfilter-branchを使用して対応する
- 使い方のマニュアルを適宜整備する
    - ドキュメントはdocs以下に配置する
    - トップのREADME.mdに概要を記載する
- 最終的には、Webサービスとしてデプロイしたい(個人用)
    - GETリクエストでURLを受け取り、RSS Feedを生成して返す
```

こんな感じで目標になりそうなことを書いてから、claudeを起動して、このファイルを読ませて仕様の検討をまずさせます。適当にやりとりした後、仕様をはっきりさせる(spec.mdという形で作成させる)、ブランチを切って作業させるという流れです。

# 仕様の例

```markdown spec.md
# feedgen 仕様書（EARS表記法）

## システム概要

URLの内容を分析してRSS Feedを生成するシステム。
コアライブラリ、CLI版、Web API版の3層構造で実装する。

## コアライブラリ（feedgen.core）

### 既存フィード検出機能

**Event**: URLが指定されたとき
**Actor**: FeedDetectorクラス
**Response**: 指定されたURLに既存のRSS/Atomフィードが存在するかを検出し、発見した場合は代理取得する
**System**: feedgen.core.FeedDetector

#### 詳細動作

1. HTMLのlinkタグ（rel="alternate"）からフィードを検出
2. 一般的なフィードパス（/feed, /rss, /atom.xml等）を確認
3. 発見したフィードの取得・配信

#### 対応フィード形式

- RSS 2.0（application/rss+xml）
- Atom（application/atom+xml）
- JSON Feed（application/json）

### Feed生成機能

**Event**: URLが指定されたとき（既存フィードが見つからない場合）
**Actor**: FeedGeneratorクラス
**Response**: 指定されたURLの内容を分析し、RSS形式のフィードを生成する
**System**: feedgen.core.FeedGenerator
(以下略)
```

こうすると、リミッターでしばらく動けなくなったとしても、あとでtask.mdとspec.mdを見ることで思い出しが容易になります(そうなると期待し、それなりに動いていると思われる)。

# 開発の流れ

開発を実際に行う際には、いきなり始めさせずに、以下の文言のようなものを指示として入れています。

「spec.mdを必ず確認し、今回の作業で必要な仕様を確認した上で、実装を行うこと。必要な仕様がない場合は、まずはその仕様を追加すること。」
「必ずテストを作り、Red-Green-Refactorのサイクルを守ること。」
「1トピック1コミットの原則を守ること」

これらの指示により、万一ダメな方向になったとしても手戻りがしやすくなります。
また、実装の前には必ずブランチで作業するようにしているので、ダメなときは`git reset --hard`で戻せるので安心ですね。

# まとめ

このように、n番煎じのフィードジェネレーターを作るにあたっても、AIの力を借りて開発を進めています。
現在追加の機能として、以下を実装しています(完了もあれば作業中もある)。

- YouTubeの検索URLを渡すと、該当動画の概要まで含めたRSS Feedを生成(YouTube Data APIを使用)
- Google Newsを喰わせたときに、記事のタイトルと概要を含めたRSS Feedを生成
  - リンクがGoogleを踏む形になっているので、事前に(可能な範囲で)ソースのURLに置換する機能(実装中)
  - キャッシュによる負荷軽減(実装中)
- フィード生成ロジックの抽象化で、今後同様にRSSを持たないものに対する実装を容易にする設計

前々から作りたいと思っていたものをこうやって自力だけでは足りない部分をかなり補ってもらえるようになったのはとても重要ですね。こういう形での創作活動もいいものですよ。

<div class="booklink-box" style="text-align:left;padding-bottom:20px;font-size:small;zoom: 1;overflow: hidden;"><div class="booklink-image" style="float:left;margin:0 15px 10px 0;"><a href="//af.moshimo.com/af/c/click?a_id=1175594&p_id=56&pc_id=56&pl_id=637&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fbooks.rakuten.co.jp%2Frb%2F17974210%2F%3Frafcid%3Dwsc_b_bs_1051722217600006323" target="_blank" ><img src="https://thumbnail.image.rakuten.co.jp/@0_mall/book/cabinet/4845/9784297144845_1_3.jpg?_ex=200x200" style="border: none;" /></a><img src="//i.moshimo.com/af/i/impression?a_id=1175594&p_id=56&pc_id=56&pl_id=637" width="1" height="1" style="border:none;"></div><div class="booklink-info" style="line-height:120%;zoom: 1;overflow: hidden;"><div class="booklink-name" style="margin-bottom:10px;line-height:120%"><a href="//af.moshimo.com/af/c/click?a_id=1175594&p_id=56&pc_id=56&pl_id=637&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fbooks.rakuten.co.jp%2Frb%2F17974210%2F%3Frafcid%3Dwsc_b_bs_1051722217600006323" target="_blank" >コード×AI-ソフトウェア開発者のための生成AI実践入門</a><img src="//i.moshimo.com/af/i/impression?a_id=1175594&p_id=56&pc_id=56&pl_id=637" width="1" height="1" style="border:none;"><div class="booklink-powered-date" style="font-size:8pt;margin-top:5px;font-family:verdana;line-height:120%">posted with <a href="https://yomereba.com" rel="nofollow" target="_blank">ヨメレバ</a></div></div><div class="booklink-detail" style="margin-bottom:5px;">服部 佑樹 技術評論社 2024年09月19日頃    </div><div class="booklink-link2" style="margin-top:10px;"><div class="shoplinkrakuten" style="display:inline;margin-right:5px"><a href="//af.moshimo.com/af/c/click?a_id=1175594&p_id=56&pc_id=56&pl_id=637&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fbooks.rakuten.co.jp%2Frb%2F17974210%2F%3Frafcid%3Dwsc_b_bs_1051722217600006323" target="_blank" >楽天ブックス</a><img src="//i.moshimo.com/af/i/impression?a_id=1175594&p_id=56&pc_id=56&pl_id=637" width="1" height="1" style="border:none;"></div><div class="shoplinkamazon" style="display:inline;margin-right:5px"><a href="//af.moshimo.com/af/c/click?a_id=920708&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=https%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4297144840" target="_blank" >Amazon</a></div><div class="shoplinkkindle" style="display:inline;margin-right:5px"><a href="//af.moshimo.com/af/c/click?a_id=920708&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=https%3A%2F%2Fwww.amazon.co.jp%2Fgp%2Fsearch%3Fkeywords%3D%25E3%2582%25B3%25E3%2583%25BC%25E3%2583%2589%25C3%2597AI-%25E3%2582%25BD%25E3%2583%2595%25E3%2583%2588%25E3%2582%25A6%25E3%2582%25A7%25E3%2582%25A2%25E9%2596%258B%25E7%2599%25BA%25E8%2580%2585%25E3%2581%25AE%25E3%2581%259F%25E3%2582%2581%25E3%2581%25AE%25E7%2594%259F%25E6%2588%2590AI%25E5%25AE%259F%25E8%25B7%25B5%25E5%2585%25A5%25E9%2596%2580%26__mk_ja_JP%3D%2583J%2583%255E%2583J%2583i%26url%3Dnode%253D2275256051" target="_blank" >Kindle</a></div>                              	  	  	  	  	</div></div><div class="booklink-footer" style="clear: left"></div></div>
